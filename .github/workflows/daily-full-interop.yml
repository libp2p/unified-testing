name: Daily Full Interoperability Tests

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:
    inputs:
      # Transport parameters
      transport-test-select:
        description: '[Transport] Select specific tests (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      transport-test-ignore:
        description: '[Transport] Ignore specific tests (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      transport-force-matrix-rebuild:
        description: '[Transport] Force test matrix regeneration'
        required: false
        default: false
        type: boolean
      transport-force-image-rebuild:
        description: '[Transport] Force Docker image rebuilds'
        required: false
        default: false
        type: boolean
      transport-debug:
        description: '[Transport] Enable debug mode'
        required: false
        default: false
        type: boolean
      # Hole-punch parameters
      hole-punch-test-select:
        description: '[Hole-punch] Select specific tests (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-test-ignore:
        description: '[Hole-punch] Ignore specific tests (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      hole-punch-relay-select:
        description: '[Hole-punch] Select specific relays (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-relay-ignore:
        description: '[Hole-punch] Ignore specific relays (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      hole-punch-router-select:
        description: '[Hole-punch] Select specific routers (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-router-ignore:
        description: '[Hole-punch] Ignore specific routers (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      hole-punch-force-matrix-rebuild:
        description: '[Hole-punch] Force test matrix regeneration'
        required: false
        default: false
        type: boolean
      hole-punch-force-image-rebuild:
        description: '[Hole-punch] Force Docker image rebuilds'
        required: false
        default: false
        type: boolean
      hole-punch-debug:
        description: '[Hole-punch] Enable debug mode'
        required: false
        default: false
        type: boolean
      # Perf parameters
      perf-test-select:
        description: '[Perf] Select specific implementations to test (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      perf-test-ignore:
        description: '[Perf] Ignore specific implementations (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      perf-baseline-select:
        description: '[Perf] Select specific baseline tests (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      perf-baseline-ignore:
        description: '[Perf] Ignore specific baseline tests (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      perf-iterations:
        description: '[Perf] Number of iterations per test'
        required: false
        default: 10
        type: number
      perf-force-matrix-rebuild:
        description: '[Perf] Force test matrix regeneration'
        required: false
        default: false
        type: boolean
      perf-force-image-rebuild:
        description: '[Perf] Force Docker image rebuilds'
        required: false
        default: false
        type: boolean
      perf-debug:
        description: '[Perf] Enable debug mode'
        required: false
        default: false
        type: boolean
      # Misc parameters
      misc-test-select:
        description: '[Misc] Select specific tests (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      misc-test-ignore:
        description: '[Misc] Ignore specific tests (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      misc-protocol-select:
        description: '[Misc] Select specific protocols (pipe-separated, e.g. "ping|echo")'
        required: false
        default: ''
        type: string
      misc-protocol-ignore:
        description: '[Misc] Ignore specific protocols (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      misc-force-matrix-rebuild:
        description: '[Misc] Force test matrix regeneration'
        required: false
        default: false
        type: boolean
      misc-force-image-rebuild:
        description: '[Misc] Force Docker image rebuilds'
        required: false
        default: false
        type: boolean
      misc-debug:
        description: '[Misc] Enable debug mode'
        required: false
        default: false
        type: boolean
      # Upload control
      upload-results:
        description: 'Upload merged results to Filebase S3 bucket'
        required: false
        default: false
        type: boolean
      export-docker-images:
        description: 'Export Docker images in snapshot (enabled by default on schedule, disabled on manual)'
        required: false
        default: false
        type: boolean

jobs:
  resolve-transport-parameters:
    runs-on: [self-hosted, linux, x64, ephemeral]
    outputs:
      test-select: ${{ steps.resolve.outputs.test-select }}
      test-ignore: ${{ steps.resolve.outputs.test-ignore }}
      force-matrix-rebuild: ${{ steps.resolve.outputs.force-matrix-rebuild }}
      force-image-rebuild: ${{ steps.resolve.outputs.force-image-rebuild }}
      debug: ${{ steps.resolve.outputs.debug }}
      should-run-tests: ${{ steps.resolve.outputs.should-run-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve transport parameters
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            echo "test-select=${{ github.event.inputs.transport-test-select }}" >> $GITHUB_OUTPUT
            echo "test-ignore=${{ github.event.inputs.transport-test-ignore }}" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ github.event.inputs.transport-force-matrix-rebuild }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=${{ github.event.inputs.transport-force-image-rebuild }}" >> $GITHUB_OUTPUT
            echo "debug=${{ github.event.inputs.transport-debug }}" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "→ Manual trigger: using workflow inputs for transport"
          else
            # Automatic trigger - check for changes in last 24 hours
            CHANGES=$(git log --oneline --since="24 hours ago" -- "transport/**" | wc -l)
            IMPLS_CHANGES=$(git log --oneline --since="24 hours ago" -- "transport/images.yaml" | wc -l)

            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT

            if [ "$CHANGES" -gt 0 ]; then
              echo "should-run-tests=true" >> $GITHUB_OUTPUT
              if [ "$IMPLS_CHANGES" -gt 0 ]; then
                echo "force-matrix-rebuild=true" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: transport changes detected, images.yaml changed"
              else
                echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: transport changes detected"
              fi
            else
              echo "should-run-tests=false" >> $GITHUB_OUTPUT
              echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
              echo "→ Automatic trigger: no transport changes in last 24h"
            fi
          fi

      - name: Debug outputs
        shell: bash
        run: |
          echo "DEBUG: should-run-tests output = '${{ steps.resolve.outputs.should-run-tests }}'"
          echo "DEBUG: github.event_name = '${{ github.event_name }}'"

  resolve-hole-punch-parameters:
    runs-on: [self-hosted, linux, x64, ephemeral]
    outputs:
      test-select: ${{ steps.resolve.outputs.test-select }}
      test-ignore: ${{ steps.resolve.outputs.test-ignore }}
      relay-select: ${{ steps.resolve.outputs.relay-select }}
      relay-ignore: ${{ steps.resolve.outputs.relay-ignore }}
      router-select: ${{ steps.resolve.outputs.router-select }}
      router-ignore: ${{ steps.resolve.outputs.router-ignore }}
      force-matrix-rebuild: ${{ steps.resolve.outputs.force-matrix-rebuild }}
      force-image-rebuild: ${{ steps.resolve.outputs.force-image-rebuild }}
      debug: ${{ steps.resolve.outputs.debug }}
      should-run-tests: ${{ steps.resolve.outputs.should-run-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve hole-punch parameters
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            echo "test-select=${{ github.event.inputs.hole-punch-test-select }}" >> $GITHUB_OUTPUT
            echo "test-ignore=${{ github.event.inputs.hole-punch-test-ignore }}" >> $GITHUB_OUTPUT
            echo "relay-select=${{ github.event.inputs.hole-punch-relay-select }}" >> $GITHUB_OUTPUT
            echo "relay-ignore=${{ github.event.inputs.hole-punch-relay-ignore }}" >> $GITHUB_OUTPUT
            echo "router-select=${{ github.event.inputs.hole-punch-router-select }}" >> $GITHUB_OUTPUT
            echo "router-ignore=${{ github.event.inputs.hole-punch-router-ignore }}" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ github.event.inputs.hole-punch-force-matrix-rebuild }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=${{ github.event.inputs.hole-punch-force-image-rebuild }}" >> $GITHUB_OUTPUT
            echo "debug=${{ github.event.inputs.hole-punch-debug }}" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "→ Manual trigger: using workflow inputs for hole-punch"
          else
            # Automatic trigger - check for changes in last 24 hours
            CHANGES=$(git log --oneline --since="24 hours ago" -- "hole-punch/**" | wc -l)
            IMPLS_CHANGES=$(git log --oneline --since="24 hours ago" -- "hole-punch/images.yaml" | wc -l)

            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "relay-select=" >> $GITHUB_OUTPUT
            echo "relay-ignore=" >> $GITHUB_OUTPUT
            echo "router-select=" >> $GITHUB_OUTPUT
            echo "router-ignore=" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT

            if [ "$CHANGES" -gt 0 ]; then
              echo "should-run-tests=true" >> $GITHUB_OUTPUT
              if [ "$IMPLS_CHANGES" -gt 0 ]; then
                echo "force-matrix-rebuild=true" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: hole-punch changes detected, images.yaml changed"
              else
                echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: hole-punch changes detected"
              fi
            else
              echo "should-run-tests=false" >> $GITHUB_OUTPUT
              echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
              echo "→ Automatic trigger: no hole-punch changes in last 24h"
            fi
          fi

  resolve-perf-parameters:
    runs-on: [self-hosted, linux, x64, ephemeral]
    outputs:
      test-select: ${{ steps.resolve.outputs.test-select }}
      test-ignore: ${{ steps.resolve.outputs.test-ignore }}
      baseline-select: ${{ steps.resolve.outputs.baseline-select }}
      baseline-ignore: ${{ steps.resolve.outputs.baseline-ignore }}
      iterations: ${{ steps.resolve.outputs.iterations }}
      force-matrix-rebuild: ${{ steps.resolve.outputs.force-matrix-rebuild }}
      force-image-rebuild: ${{ steps.resolve.outputs.force-image-rebuild }}
      debug: ${{ steps.resolve.outputs.debug }}
      should-run-tests: ${{ steps.resolve.outputs.should-run-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve perf parameters
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            echo "test-select=${{ github.event.inputs.perf-test-select }}" >> $GITHUB_OUTPUT
            echo "test-ignore=${{ github.event.inputs.perf-test-ignore }}" >> $GITHUB_OUTPUT
            echo "baseline-select=${{ github.event.inputs.perf-baseline-select }}" >> $GITHUB_OUTPUT
            echo "baseline-ignore=${{ github.event.inputs.perf-baseline-ignore }}" >> $GITHUB_OUTPUT
            echo "iterations=${{ github.event.inputs.perf-iterations }}" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ github.event.inputs.perf-force-matrix-rebuild }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=${{ github.event.inputs.perf-force-image-rebuild }}" >> $GITHUB_OUTPUT
            echo "debug=${{ github.event.inputs.perf-debug }}" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "→ Manual trigger: using workflow inputs for perf"
          else
            # Automatic trigger - check for changes in last 24 hours
            CHANGES=$(git log --oneline --since="24 hours ago" -- "perf/**" | wc -l)
            IMPLS_CHANGES=$(git log --oneline --since="24 hours ago" -- "perf/images.yaml" | wc -l)

            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "baseline-select=" >> $GITHUB_OUTPUT
            echo "baseline-ignore=~failing" >> $GITHUB_OUTPUT
            echo "iterations=10" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT

            if [ "$CHANGES" -gt 0 ]; then
              echo "should-run-tests=true" >> $GITHUB_OUTPUT
              if [ "$IMPLS_CHANGES" -gt 0 ]; then
                echo "force-matrix-rebuild=true" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: perf changes detected, images.yaml changed"
              else
                echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: perf changes detected"
              fi
            else
              echo "should-run-tests=false" >> $GITHUB_OUTPUT
              echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
              echo "→ Automatic trigger: no perf changes in last 24h"
            fi
          fi

  resolve-misc-parameters:
    runs-on: [self-hosted, linux, x64, ephemeral]
    outputs:
      test-select: ${{ steps.resolve.outputs.test-select }}
      test-ignore: ${{ steps.resolve.outputs.test-ignore }}
      protocol-select: ${{ steps.resolve.outputs.protocol-select }}
      protocol-ignore: ${{ steps.resolve.outputs.protocol-ignore }}
      force-matrix-rebuild: ${{ steps.resolve.outputs.force-matrix-rebuild }}
      force-image-rebuild: ${{ steps.resolve.outputs.force-image-rebuild }}
      debug: ${{ steps.resolve.outputs.debug }}
      should-run-tests: ${{ steps.resolve.outputs.should-run-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve misc parameters
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            echo "test-select=${{ github.event.inputs.misc-test-select }}" >> $GITHUB_OUTPUT
            echo "test-ignore=${{ github.event.inputs.misc-test-ignore }}" >> $GITHUB_OUTPUT
            echo "protocol-select=${{ github.event.inputs.misc-protocol-select }}" >> $GITHUB_OUTPUT
            echo "protocol-ignore=${{ github.event.inputs.misc-protocol-ignore }}" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ github.event.inputs.misc-force-matrix-rebuild }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=${{ github.event.inputs.misc-force-image-rebuild }}" >> $GITHUB_OUTPUT
            echo "debug=${{ github.event.inputs.misc-debug }}" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "→ Manual trigger: using workflow inputs for misc"
          else
            # Automatic trigger - check for changes in last 24 hours
            CHANGES=$(git log --oneline --since="24 hours ago" -- "misc/**" | wc -l)
            IMPLS_CHANGES=$(git log --oneline --since="24 hours ago" -- "misc/images.yaml" | wc -l)

            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "protocol-select=" >> $GITHUB_OUTPUT
            echo "protocol-ignore=~failing" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT

            if [ "$CHANGES" -gt 0 ]; then
              echo "should-run-tests=true" >> $GITHUB_OUTPUT
              if [ "$IMPLS_CHANGES" -gt 0 ]; then
                echo "force-matrix-rebuild=true" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: misc changes detected, images.yaml changed"
              else
                echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
                echo "→ Automatic trigger: misc changes detected"
              fi
            else
              echo "should-run-tests=false" >> $GITHUB_OUTPUT
              echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
              echo "→ Automatic trigger: no misc changes in last 24h"
            fi
          fi

  run-transport-full:
    needs: resolve-transport-parameters
    if: ${{ !cancelled() && (github.event_name == 'workflow_dispatch' || needs.resolve-transport-parameters.outputs.should-run-tests) }}
    runs-on: [self-hosted, linux, x64, ephemeral]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full transport interop tests
        uses: ./.github/actions/run-bash-transport-test
        with:
          test-select: '${{ needs.resolve-transport-parameters.outputs.test-select }}'
          test-ignore: '${{ needs.resolve-transport-parameters.outputs.test-ignore }}'
          cache-dir: /srv/cache
          snapshot: true
          export-docker-images: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.export-docker-images == 'true' }}
          force-matrix-rebuild: ${{ needs.resolve-transport-parameters.outputs.force-matrix-rebuild }}
          force-image-rebuild: ${{ needs.resolve-transport-parameters.outputs.force-image-rebuild }}
          debug: ${{ needs.resolve-transport-parameters.outputs.debug }}

  run-hole-punch-full:
    needs: resolve-hole-punch-parameters
    if: ${{ !cancelled() && (github.event_name == 'workflow_dispatch' || needs.resolve-hole-punch-parameters.outputs.should-run-tests) }}
    runs-on: [self-hosted, linux, x64, ephemeral]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full hole punch interop tests
        uses: ./.github/actions/run-bash-hole-punch-test
        with:
          test-select: '${{ needs.resolve-hole-punch-parameters.outputs.test-select }}'
          test-ignore: '${{ needs.resolve-hole-punch-parameters.outputs.test-ignore }}'
          relay-select: '${{ needs.resolve-hole-punch-parameters.outputs.relay-select }}'
          relay-ignore: '${{ needs.resolve-hole-punch-parameters.outputs.relay-ignore }}'
          router-select: '${{ needs.resolve-hole-punch-parameters.outputs.router-select }}'
          router-ignore: '${{ needs.resolve-hole-punch-parameters.outputs.router-ignore }}'
          cache-dir: /srv/cache
          snapshot: true
          export-docker-images: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.export-docker-images == 'true' }}
          force-matrix-rebuild: ${{ needs.resolve-hole-punch-parameters.outputs.force-matrix-rebuild }}
          force-image-rebuild: ${{ needs.resolve-hole-punch-parameters.outputs.force-image-rebuild }}
          debug: ${{ needs.resolve-hole-punch-parameters.outputs.debug }}

  run-perf-full:
    needs: resolve-perf-parameters
    if: ${{ !cancelled() && (github.event_name == 'workflow_dispatch' || needs.resolve-perf-parameters.outputs.should-run-tests) }}
    runs-on: [self-hosted, linux, x64, ephemeral]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full perf benchmarks
        uses: ./.github/actions/run-bash-perf-test
        with:
          test-select: '${{ needs.resolve-perf-parameters.outputs.test-select }}'
          test-ignore: '${{ needs.resolve-perf-parameters.outputs.test-ignore }}'
          baseline-select: '${{ needs.resolve-perf-parameters.outputs.baseline-select }}'
          baseline-ignore: '${{ needs.resolve-perf-parameters.outputs.baseline-ignore }}'
          iterations: '${{ needs.resolve-perf-parameters.outputs.iterations }}'
          cache-dir: /srv/cache
          snapshot: true
          export-docker-images: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.export-docker-images == 'true' }}
          force-matrix-rebuild: ${{ needs.resolve-perf-parameters.outputs.force-matrix-rebuild }}
          force-image-rebuild: ${{ needs.resolve-perf-parameters.outputs.force-image-rebuild }}
          debug: ${{ needs.resolve-perf-parameters.outputs.debug }}

  run-misc-full:
    needs: resolve-misc-parameters
    if: ${{ !cancelled() && (github.event_name == 'workflow_dispatch' || needs.resolve-misc-parameters.outputs.should-run-tests) }}
    runs-on: [self-hosted, linux, x64, ephemeral]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full misc protocol interop tests
        uses: ./.github/actions/run-bash-misc-test
        with:
          test-select: '${{ needs.resolve-misc-parameters.outputs.test-select }}'
          test-ignore: '${{ needs.resolve-misc-parameters.outputs.test-ignore }}'
          protocol-select: '${{ needs.resolve-misc-parameters.outputs.protocol-select }}'
          protocol-ignore: '${{ needs.resolve-misc-parameters.outputs.protocol-ignore }}'
          cache-dir: /srv/cache
          snapshot: true
          force-matrix-rebuild: ${{ needs.resolve-misc-parameters.outputs.force-matrix-rebuild }}
          force-image-rebuild: ${{ needs.resolve-misc-parameters.outputs.force-image-rebuild }}
          debug: ${{ needs.resolve-misc-parameters.outputs.debug }}

  merge-and-upload-results:
    needs: [run-transport-full, run-hole-punch-full, run-perf-full, run-misc-full]
    if: |
      always() &&
      (needs.run-transport-full.result != 'skipped' ||
       needs.run-hole-punch-full.result != 'skipped' ||
       needs.run-perf-full.result != 'skipped' ||
       needs.run-misc-full.result != 'skipped')
    runs-on: [self-hosted, linux, x64, ephemeral]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download transport test results
        if: needs.run-transport-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: transport-test-results-*
          path: /tmp/transport-results
          merge-multiple: true

      - name: Download hole-punch test results
        if: needs.run-hole-punch-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: hole-punch-test-results-*
          path: /tmp/hole-punch-results
          merge-multiple: true

      - name: Download perf test results
        if: needs.run-perf-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: perf-test-results-*
          path: /tmp/perf-results
          merge-multiple: true

      - name: Download perf box plots
        if: needs.run-perf-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: perf-test-box-plot-*
          path: /tmp/perf-boxplots
          merge-multiple: true

      - name: Download misc test results
        if: needs.run-misc-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: misc-test-results-*
          path: /tmp/misc-results
          merge-multiple: true

      - name: Debug artifact structures
        shell: bash
        run: |
          echo "=== Transport artifact ==="
          find /tmp/transport-results -type f 2>/dev/null | head -20 || echo "No transport results found"
          TRANSPORT_YAML=$(find /tmp/transport-results -name "results.yaml" 2>/dev/null | head -1)
          if [ -n "$TRANSPORT_YAML" ] && [ -f "$TRANSPORT_YAML" ]; then
            echo "--- First test entry ---"
            yq eval '.tests[0]' "$TRANSPORT_YAML" 2>/dev/null || echo "No tests found"
          fi

          echo ""
          echo "=== Hole-punch artifact ==="
          find /tmp/hole-punch-results -type f 2>/dev/null | head -20 || echo "No hole-punch results found"
          HP_YAML=$(find /tmp/hole-punch-results -name "results.yaml" 2>/dev/null | head -1)
          if [ -n "$HP_YAML" ] && [ -f "$HP_YAML" ]; then
            echo "--- First test entry ---"
            yq eval '.tests[0]' "$HP_YAML" 2>/dev/null || echo "No tests found"
          fi

          echo ""
          echo "=== Perf artifact ==="
          find /tmp/perf-results -type f 2>/dev/null | head -20 || echo "No perf results found"
          PERF_YAML=$(find /tmp/perf-results -name "results.yaml" 2>/dev/null | head -1)
          if [ -n "$PERF_YAML" ] && [ -f "$PERF_YAML" ]; then
            echo "--- First baseline entry ---"
            yq eval '.baselineResults[0]' "$PERF_YAML" 2>/dev/null || echo "No baseline results found"
            echo "--- First test entry ---"
            yq eval '.testResults[0]' "$PERF_YAML" 2>/dev/null || echo "No test results found"
          fi


      - name: Find result directories and prepare merge
        id: find-results
        shell: bash
        run: |
          # Find transport results directory
          TRANSPORT_DIR=""
          if [ -d /tmp/transport-results ]; then
            if [ -f /tmp/transport-results/results.yaml ]; then
              TRANSPORT_DIR="/tmp/transport-results"
            else
              # Results might be in a subdirectory
              TRANSPORT_DIR=$(find /tmp/transport-results -name "results.yaml" -exec dirname {} \; | head -1)
            fi
          fi
          echo "transport-dir=$TRANSPORT_DIR" >> $GITHUB_OUTPUT
          echo "→ Transport results: ${TRANSPORT_DIR:-not found}"

          # Find hole-punch results directory
          HOLE_PUNCH_DIR=""
          if [ -d /tmp/hole-punch-results ]; then
            if [ -f /tmp/hole-punch-results/results.yaml ]; then
              HOLE_PUNCH_DIR="/tmp/hole-punch-results"
            else
              HOLE_PUNCH_DIR=$(find /tmp/hole-punch-results -name "results.yaml" -exec dirname {} \; | head -1)
            fi
          fi
          echo "hole-punch-dir=$HOLE_PUNCH_DIR" >> $GITHUB_OUTPUT
          echo "→ Hole-punch results: ${HOLE_PUNCH_DIR:-not found}"

          # Find perf results directory
          PERF_DIR=""
          if [ -d /tmp/perf-results ]; then
            if [ -f /tmp/perf-results/results.yaml ]; then
              PERF_DIR="/tmp/perf-results"
            else
              PERF_DIR=$(find /tmp/perf-results -name "results.yaml" -exec dirname {} \; | head -1)
            fi
          fi
          echo "perf-dir=$PERF_DIR" >> $GITHUB_OUTPUT
          echo "→ Perf results: ${PERF_DIR:-not found}"

      - name: Copy misc results to repository
        if: needs.run-misc-full.result != 'skipped'
        shell: bash
        run: |
          MISC_RESULTS_FILE=""
          if [ -d /tmp/misc-results ]; then
            if [ -f /tmp/misc-results/results.yaml ]; then
              MISC_RESULTS_FILE="/tmp/misc-results/results.yaml"
            else
              MISC_RESULTS_FILE=$(find /tmp/misc-results -name "results.yaml" | head -1)
            fi
          fi

          if [ -n "$MISC_RESULTS_FILE" ] && [ -f "$MISC_RESULTS_FILE" ]; then
            mkdir -p results
            cp "$MISC_RESULTS_FILE" results/misc-daily.yml
            echo "→ Copied misc results to results/misc-daily.yml"
          else
            echo "→ No misc results found, skipping"
          fi

      - name: Verify merge script version
        shell: bash
        run: |
          echo "=== Checking merge script uses correct field names ==="
          if grep -q '\.dialer\.id' lib/merge-interop-results.sh; then
            echo "ERROR: Script still uses old .dialer.id syntax"
            exit 1
          fi
          if grep -q '\.listener\.id' lib/merge-interop-results.sh; then
            echo "ERROR: Script still uses old .listener.id syntax"
            exit 1
          fi
          if grep -q '"name": \.id' lib/merge-interop-results.sh; then
            echo "ERROR: Script still uses old .id syntax for name"
            exit 1
          fi
          if grep -q '"status": \.outcome' lib/merge-interop-results.sh; then
            echo "ERROR: Script still uses old .outcome syntax for status"
            exit 1
          fi
          echo "Script version verified - using correct field names"

      - name: Run merge-interop-results script
        shell: bash
        run: |
          mkdir -p /tmp/merged-results
          WORKFLOW_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          bash lib/merge-interop-results.sh \
            "${{ steps.find-results.outputs.transport-dir }}" \
            "${{ steps.find-results.outputs.hole-punch-dir }}" \
            "${{ steps.find-results.outputs.perf-dir }}" \
            "/tmp/merged-results/daily-full-interop.yml" \
            "$WORKFLOW_RUN_URL"

      - name: Verify merged results
        shell: bash
        run: |
          echo "=== Merged results file ==="
          ls -la /tmp/merged-results/daily-full-interop.yml
          echo ""
          echo "=== Generated YAML content preview ==="
          head -100 /tmp/merged-results/daily-full-interop.yml

      - name: Verify AWS CLI
        if: github.event_name != 'workflow_dispatch' || inputs.upload-results
        shell: bash
        run: aws --version

      - name: Configure AWS credentials for Filebase
        if: github.event_name != 'workflow_dispatch' || inputs.upload-results
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.FILEBASE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.FILEBASE_SECRET_KEY }}
          AWS_DEFAULT_REGION: us-east-1   # Filebase ignores region, but required
        run: |
          echo "AWS credentials exported as env vars"
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region $AWS_DEFAULT_REGION
          aws configure list

      - name: Upload results to Filebase
        if: github.event_name != 'workflow_dispatch' || inputs.upload-results
        shell: bash
        env:
          AWS_EC2_METADATA_DISABLED: true
        run: |
          set -euo pipefail

          RESULTS_FILE="/tmp/merged-results/daily-full-interop.yml"
          BUCKET="test-plans-results"
          ENDPOINT="https://s3.filebase.com"
          DATE_STAMP=$(date -u +"%Y-%m-%d")

          if [ ! -f "$RESULTS_FILE" ]; then
            echo "Error: Results file not found at $RESULTS_FILE"
            exit 1
          fi

          echo "Uploading results to Filebase S3..."
          echo "  Bucket: $BUCKET"
          echo "  Endpoint: $ENDPOINT"
          echo "  Date stamp: $DATE_STAMP"

          # Upload as date-stamped archive
          echo "-> Uploading history/${DATE_STAMP}.yaml..."
          aws --endpoint "$ENDPOINT" \
            s3 cp "$RESULTS_FILE" \
            "s3://${BUCKET}/history/${DATE_STAMP}.yaml" \
            --content-type "application/x-yaml"

          # Upload as latest results (overwrite)
          echo "-> Uploading results.yaml (latest)..."
          aws --endpoint "$ENDPOINT" \
            s3 cp "$RESULTS_FILE" \
            "s3://${BUCKET}/results.yaml" \
            --content-type "application/x-yaml"

          echo "Upload complete."
          echo "  Archive: s3://${BUCKET}/history/${DATE_STAMP}.yaml"
          echo "  Latest:  s3://${BUCKET}/results.yaml"
